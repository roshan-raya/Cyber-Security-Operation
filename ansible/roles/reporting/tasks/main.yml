---
# Reporting runs on localhost (play 2); uses hostvars + groups['all'] for data
- name: Gather facts (for timestamp/duration)
  ansible.builtin.setup:

- name: Ensure reports directory exists
  ansible.builtin.file:
    path: /ansible/reports
    state: directory
    mode: "0755"

- name: Get patch start epoch for reporting (from first host in inventory)
  ansible.builtin.set_fact:
    patch_start_epoch: "{{ hostvars[groups['all'][0]]['patch_start_epoch'] | default(ansible_facts['date_time']['epoch']) }}"
  when: groups['all'] | default([]) | length > 0

- name: Build report list per host
  ansible.builtin.set_fact:
    patch_report_list: "{{ (patch_report_list | default([])) + [new_row] }}"
  vars:
    new_row:
      host: "{{ item }}"
      changed: "{{ hostvars[item].patch_changed | default(false) }}"
      ok: "{{ hostvars[item].patch_ok | default(false) }}"
      failed: "{{ hostvars[item].patch_failed | default(false) }}"
      msg: "{{ hostvars[item].patch_msg | default('') }}"
      rebooted: "{{ hostvars[item].patch_rebooted | default(false) }}"
      rollback_performed: "{{ hostvars[item].rollback_performed | default(false) }}"
      duration_seconds: "{{ ansible_facts['date_time']['epoch'] | int - (patch_start_epoch | default(ansible_facts['date_time']['epoch']) | int) }}"
      timestamp: "{{ ansible_facts['date_time']['epoch'] }}"
      group: "{{ patch_group | default('all') }}"
      environment: "{{ patch_environment | default('unspecified') }}"
  loop: "{{ groups['all'] | default([]) }}"
  when: groups['all'] | default([]) | length > 0

- name: Set patch compliance percentage
  ansible.builtin.set_fact:
    patch_compliance_percentage: "{{ ((patch_report_list | selectattr('failed', 'equalto', false) | list | length) / (patch_report_list | length) * 100.0) | round(2) if (patch_report_list | length) > 0 else 0 }}"

- name: Write patch report JSON (timestamped)
  ansible.builtin.copy:
    content: "{{ {'hosts': patch_report_list | default([]), 'duration_seconds': (ansible_facts['date_time']['epoch'] | int - (patch_start_epoch | default(ansible_facts['date_time']['epoch']) | int)), 'environment': patch_environment | default('unspecified'), 'group': patch_group | default('all'), 'compliance_percentage': patch_compliance_percentage | default(0)} | to_nice_json }}"
    dest: "/ansible/reports/patch_report_{{ ansible_facts['date_time']['epoch'] }}.json"

- name: Write patch_report_latest.json
  ansible.builtin.copy:
    content: "{{ {'hosts': patch_report_list | default([]), 'duration_seconds': (ansible_facts['date_time']['epoch'] | int - (patch_start_epoch | default(ansible_facts['date_time']['epoch']) | int)), 'environment': patch_environment | default('unspecified'), 'group': patch_group | default('all'), 'compliance_percentage': patch_compliance_percentage | default(0)} | to_nice_json }}"
    dest: "/ansible/reports/patch_report_latest.json"

- name: Write patch_report_latest.csv
  ansible.builtin.template:
    src: patch_report.csv.j2
    dest: /ansible/reports/patch_report_latest.csv

- name: Generate Prometheus patch metrics file
  ansible.builtin.template:
    src: patch_metrics.prom.j2
    dest: /ansible/reports/patch_metrics.prom

- name: Structured summary
  ansible.builtin.debug:
    msg: "Patch run complete. Report: /ansible/reports/patch_report_latest.json (env={{ patch_environment | default('unspecified') }}, group={{ patch_group | default('all') }})"
